<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Antistasi ‚Äì Green Sea Campagnekaart</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --muted:#8a93a7; --text:#e8ecf6; --accent:#60a5fa;
      --win:#22c55e; --loss:#ef4444; --other:#38bdf8;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    #app{display:grid;grid-template-columns:340px 1fr;height:100%}
    #sidebar{background:var(--panel);border-right:1px solid #212836;display:flex;flex-direction:column}
    header{padding:14px 16px;border-bottom:1px solid #212836;display:flex;align-items:center;gap:8px}
    header h1{font-size:16px;margin:0;font-weight:700}
    header small{color:var(--muted)}
    .tools{display:flex;flex-wrap:wrap;gap:8px;padding:12px 16px;border-bottom:1px solid #212836}
    button,.btn{background:#1b2230;color:#e8ecf6;border:1px solid #263043;border-radius:10px;padding:8px 10px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .btn-accent{background:#1e293b;border-color:#334155;color:#dbeafe}
    .btn-danger{background:#2a1620;border-color:#4c1d2f;color:#fecaca}
    .section{padding:12px 16px;border-bottom:1px solid #212836}
    .section h2{font-size:13px;color:#a7b0c2;text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
    .list{display:grid;gap:8px;max-height:28vh;overflow:auto}
    .card{background:#111826;border:1px solid #223047;border-radius:12px;padding:10px}
    .row{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #273245;color:#cbd5e1}
    .tag.win{border-color:#14532d;color:#bbf7d0}
    .tag.loss{border-color:#7f1d1d;color:#fecaca}
    .tag.other{border-color:#0c4a6e;color:#bae6fd}
    label{display:block;font-size:12px;color:#9aa3b6;margin-top:6px}
    input,select,textarea{width:100%;background:#0f141e;border:1px solid #233044;color:#e5eaf5;border-radius:8px;padding:8px}
    textarea{min-height:60px}
    #map{height:100%;}
    .statusbar{padding:8px 12px;color:#9aa3b6;font-size:12px;border-top:1px solid #212836}
    .tip{color:#9aa3b6;font-size:12px;margin-top:6px}
    .hidden{display:none}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <header>
      <div>
        <h1>Green Sea ‚Äì Campagne</h1>
        <small>Antistasi War Diary</small>
      </div>
    </header>

    <div class="tools">
      <button id="uploadImageBtn" class="btn-accent">üì§ Map-afbeelding laden</button>
      <input type="file" id="imageInput" accept="image/*" class="hidden" />
      <button id="toggleEdit">‚úèÔ∏è Edit-modus</button>
      <button id="saveState">üíæ Opslaan</button>
      <button id="exportJson">‚¨áÔ∏è Export</button>
      <button id="importJson">‚¨ÜÔ∏è Import</button>
    </div>

    <div class="section" id="addEventSection">
      <h2>Nieuwe gebeurtenis</h2>
      <div class="flex">
        <select id="result">
          <option value="win">Gewonnen</option>
          <option value="loss">Verloren</option>
          <option value="other">Overig</option>
        </select>
        <button id="addEvent" class="btn-accent">‚ûï Voeg toe</button>
      </div>
      <label>Naam</label>
      <input id="title" placeholder="Bijv. Slag om Zelenomorsk Harbour" />
      <label>Datum/tijd (vrij tekst)</label>
      <input id="when" placeholder="2025-08-09 21:30" />
      <label>Beschrijving</label>
      <textarea id="desc" placeholder="Korte omschrijving, verliezen, tactiek, etc."></textarea>
      <p class="tip">De marker verschijnt in het midden van de kaart. Sleep hem naar de juiste plek (edit-modus aan).</p>
    </div>

    <div class="section">
      <h2>Gebeurtenissen</h2>
      <div class="row" style="margin-bottom:6px">
        <div class="flex">
          <label class="muted" style="margin:0">Filter:</label>
          <select id="filter">
            <option value="all">Alle</option>
            <option value="win">Gewonnen</option>
            <option value="loss">Verloren</option>
            <option value="other">Overig</option>
          </select>
        </div>
        <button id="centerAll">üß≠ Center</button>
      </div>
      <div class="list" id="eventList"></div>
    </div>

    <div class="section">
      <h2>Materieel</h2>
      <div class="row" style="margin-bottom:8px">
        <input id="vehName" placeholder="Bijv. BTR-80A" />
        <input id="vehQty" type="number" min="1" value="1" style="width:80px" />
        <button id="addVeh" class="btn-accent">‚ûï</button>
      </div>
      <div class="list" id="vehList"></div>
      <h3 style="margin:10px 0 6px;font-size:12px;color:#a7b0c2;text-transform:uppercase;letter-spacing:.08em">Verliezen</h3>
      <div class="list" id="lossList"></div>
    </div>

    <div class="statusbar" id="status">Klaar.</div>
  </aside>
  <main>
    <div id="map"></div>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function(){
  // --- State ---
  const state = {
    img: null, // {url, width, height}
    edit: false,
    events: [], // {id,title,result,when,desc,pt:[x,y]}
    vehicles: [], // {name, qty}
    losses: [] // {name, qty, when, note}
  };

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -5,
    zoomSnap: 0.25,
    zoomDelta: 0.5,
    wheelPxPerZoomLevel: 120
  });

  let imageOverlay = null;
  let bounds = L.latLngBounds([[0,0],[1000,1000]]);
  map.fitBounds(bounds);

  const iconBase = (color) => L.divIcon({
    className: 'custom-icon',
    html: `<div style="width:14px;height:14px;border-radius:50%;border:2px solid #111;box-shadow:0 0 0 1px rgba(255,255,255,.15);background:${color}"></div>`,
    iconSize: [14,14],
    iconAnchor: [7,7]
  });
  const icons = {
    win: iconBase('var(--win)'),
    loss: iconBase('var(--loss)'),
    other: iconBase('var(--other)')
  };

  const markers = new Map(); // id -> marker

  // --- UI helpers ---
  const $ = (id) => document.getElementById(id);
  const status = (t) => { $("status").textContent = t };

  function renderEvents(){
    const wrap = $('eventList');
    wrap.innerHTML = '';
    const filter = $('filter').value;
    for(const ev of state.events){
      if(filter !== 'all' && ev.result !== filter) continue;
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="row">
          <strong>${ev.title}</strong>
          <span class="tag ${ev.result}">${ev.result === 'win' ? 'Gewonnen' : ev.result === 'loss' ? 'Verloren' : 'Overig'}</span>
        </div>
        <div class="muted" style="margin-top:4px">${ev.when || ''}</div>
        <div style="margin-top:6px">${(ev.desc||'').replace(/</g,'&lt;')}</div>
        <div class="row" style="margin-top:8px;gap:6px">
          <button data-act="fly" data-id="${ev.id}">üß≠ Zoom</button>
          <button data-act="edit" data-id="${ev.id}">‚úèÔ∏è</button>
          <button class="btn-danger" data-act="del" data-id="${ev.id}">üóëÔ∏è</button>
        </div>`;
      wrap.appendChild(div);
    }
  }

  function refreshMarkers(){
    for(const [id,m] of markers){ m.remove(); }
    markers.clear();
    for(const ev of state.events){
      const m = L.marker(ev.pt || centerPoint(), {draggable: state.edit, icon: icons[ev.result]});
      m.addTo(map).bindPopup(`<strong>${ev.title}</strong><br>${ev.when||''}<br><em>${ev.result}</em><br>${(ev.desc||'').replace(/</g,'&lt;')}`);
      m.on('dragend', () => {
        const p = m.getLatLng();
        ev.pt = [p.lat, p.lng];
        save();
      });
      markers.set(ev.id, m);
    }
  }

  function centerPoint(){
    const b = bounds; const lat = (b.getNorth() + b.getSouth())/2; const lng = (b.getEast() + b.getWest())/2; return [lat,lng];
  }

  function save(){
    localStorage.setItem('antistasiGreenSea', JSON.stringify(state));
  }
  function load(){
    const raw = localStorage.getItem('antistasiGreenSea');
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      Object.assign(state, s);
    }catch(e){ console.warn(e); }
  }

  function setImage(src, width, height){
    if(imageOverlay) { map.removeLayer(imageOverlay); }
    state.img = {url: src, width, height};
    bounds = L.latLngBounds([[0,0],[height,width]]);
    imageOverlay = L.imageOverlay(src, bounds).addTo(map);
    map.fitBounds(bounds);
    refreshMarkers();
  }

  // --- Vehicles ---
  function renderVehicles(){
    const v = $('vehList'); v.innerHTML = '';
    for(const item of state.vehicles){
      const row = document.createElement('div');
      row.className = 'card';
      row.innerHTML = `
        <div class="row"><strong>${item.name}</strong><span class="tag">x${item.qty}</span></div>
        <div class="row" style="margin-top:8px">
          <button data-vact="loss" data-name="${item.name}">Markeer verlies</button>
          <button class="btn-danger" data-vact="del" data-name="${item.name}">Verwijder</button>
        </div>`;
      v.appendChild(row);
    }

    const l = $('lossList'); l.innerHTML = '';
    for(const loss of state.losses){
      const row = document.createElement('div');
      row.className = 'card';
      row.innerHTML = `<div class="row"><strong>${loss.name}</strong><span class="tag loss">-${loss.qty}</span></div><div class="muted" style="margin-top:4px">${loss.when||''}</div><div>${(loss.note||'').replace(/</g,'&lt;')}</div>`;
      l.appendChild(row);
    }
  }

  // --- Seed initial data if empty ---
  function seedIfEmpty(){
    if(state.events.length===0){
      const seedEvents = [
        {title:'Slag om Zelenomorsk Factory', result:'win', when:'2025-07-12 21:00', desc:''},
        {title:'Slag om Volkovo Military Outpost', result:'win', when:'2025-07-16 20:30', desc:''},
        {title:'Slag om Zelenomorsk Harbour', result:'win', when:'2025-07-20 21:15', desc:''},
        {title:'Slag om Military Base Zamok Dozornyy', result:'loss', when:'2025-07-23 22:00', desc:''},
        {title:'Slag om Svyatnyy Airbase', result:'loss', when:'2025-07-27 22:30', desc:'Zware nederlaag'},
        {title:'Tweede slag om Military Base Zamok Dozornyy', result:'win', when:'2025-08-03 21:45', desc:'Gewonnen met zware verliezen'}
      ];
      state.events = seedEvents.map((e,i)=>({id:crypto.randomUUID(), pt:centerPoint(), ...e}));
    }
    if(state.vehicles.length===0){
      state.vehicles = [
        {name:'BTR-80A', qty:1},
        {name:'GAZ-66', qty:3},
        {name:'M1151A1 (diverse wapens)', qty:5},
        {name:'ZIL-131', qty:2},
        {name:'M113A3 .50 ammo carrier', qty:1}
      ];
    }
  }

  // --- Wire UI ---
  $('uploadImageBtn').addEventListener('click', ()=> $('imageInput').click());
  $('imageInput').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { setImage(url, img.width, img.height); status('Map-afbeelding geladen.'); };
    img.src = url;
  });

  $('toggleEdit').addEventListener('click', ()=>{
    state.edit = !state.edit; status(state.edit? 'Edit-modus: markers sleepbaar' : 'Edit-modus uit');
    refreshMarkers();
  });

  $('saveState').addEventListener('click', ()=>{ save(); status('Opgeslagen in je browser (localStorage).'); });

  $('exportJson').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'antistasi-green-sea.json'; a.click();
  });

  $('importJson').addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const rd = new FileReader();
      rd.onload = () => { Object.assign(state, JSON.parse(rd.result)); reinitAfterLoad(); status('Data ge√Ømporteerd.'); };
      rd.readAsText(f);
    };
    inp.click();
  });

  $('addEvent').addEventListener('click', ()=>{
    const ev = {
      id: crypto.randomUUID(),
      title: $('title').value || 'Onbenoemde gebeurtenis',
      result: $('result').value,
      when: $('when').value,
      desc: $('desc').value,
      pt: centerPoint()
    };
    state.events.unshift(ev);
    $('title').value = $('when').value = $('desc').value = '';
    renderEvents(); refreshMarkers(); save(); status('Gebeurtenis toegevoegd.');
  });

  $('eventList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const act = btn.dataset.act; const ev = state.events.find(x=>x.id===id);
    if(!ev) return;
    if(act==='fly'){
      const m = markers.get(id); if(m){ map.setView(m.getLatLng(), map.getZoom()>0 ? map.getZoom() : 0); m.openPopup(); }
    } else if(act==='edit'){
      const title = prompt('Titel', ev.title); if(title===null) return; ev.title = title;
      const when = prompt('Datum/tijd', ev.when||''); ev.when = when===null?ev.when:when;
      const desc = prompt('Beschrijving', ev.desc||''); ev.desc = desc===null?ev.desc:desc;
      const result = prompt('Resultaat (win/loss/other)', ev.result); if(result && ['win','loss','other'].includes(result)) ev.result=result;
      renderEvents(); refreshMarkers(); save();
    } else if(act==='del'){
      if(confirm('Verwijder deze gebeurtenis?')){
        state.events = state.events.filter(x=>x.id!==id);
        renderEvents(); refreshMarkers(); save();
      }
    }
  });

  $('filter').addEventListener('change', renderEvents);
  $('centerAll').addEventListener('click', ()=> map.fitBounds(bounds));

  $('addVeh').addEventListener('click', ()=>{
    const name = $('vehName').value.trim(); if(!name) return;
    const qty = Math.max(1, parseInt($('vehQty').value||'1',10));
    const found = state.vehicles.find(v=>v.name===name);
    if(found) found.qty += qty; else state.vehicles.push({name, qty});
    $('vehName').value=''; $('vehQty').value=1; renderVehicles(); save(); status('Materieel bijgewerkt.');
  });

  $('vehList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const name = btn.dataset.name; const act = btn.dataset.vact; const v = state.vehicles.find(x=>x.name===name);
    if(!v) return;
    if(act==='loss'){
      const q = parseInt(prompt('Aantal verloren', '1')||'0',10); if(!q||q<=0) return;
      const note = prompt('Opmerking (bijv. oorzaak/verliezen)')||'';
      const when = prompt('Datum/tijd', new Date().toISOString().slice(0,16).replace('T',' '));
      v.qty -= q; if(v.qty<=0) state.vehicles = state.vehicles.filter(x=>x.qty>0);
      state.losses.unshift({name, qty:q, when, note});
      renderVehicles(); save(); status('Verlies geregistreerd.');
    } else if(act==='del'){
      if(confirm('Verwijder materieel item?')){ state.vehicles = state.vehicles.filter(x=>x!==v); renderVehicles(); save(); }
    }
  });

  function reinitAfterLoad(){
    // restore image
    if(state.img){ setImage(state.img.url, state.img.width, state.img.height); }
    refreshMarkers(); renderEvents(); renderVehicles();
  }

  // --- init ---
  load(); seedIfEmpty(); reinitAfterLoad();
  status('Laad je Green Sea screenshot (rechtsboven: üì§) en sleep markers naar de juiste locaties.');
})();
</script>
</body>
</html>
